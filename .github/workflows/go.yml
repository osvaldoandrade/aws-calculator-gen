name: CI, Tag & Release (macOS DMG drag, Linux RPM/DEB incl. Raspberry Pi)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: aws-calculator-gen
  APP_DISPLAY: "AWS Calculator Generator"
  BUNDLE_ID: br.com.codecompany
  VOL_NAME: "AWS Calculator Generator"
  MAIN_PKG: ./cmd/aws-calculator-gen

jobs:
  build-test:
    name: Build & Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure pricing.yaml exists
        run: |
          test -f pricing.yaml || { echo "pricing.yaml não encontrado na raiz do repo"; exit 1; }
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: '1.22', cache: true }
      - name: Build
        run: go build -v ./...
      - name: Test
        run: go test -v ./...

  tag:
    name: Compute & Push Tag
    runs-on: ubuntu-latest
    needs: build-test
    outputs:
      TAG_NAME: ${{ steps.version.outputs.tag }}
      VERSION: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - id: version
        name: Compute next tag (patch bump)
        shell: bash
        run: |
          git fetch --tags
          LATEST_TAG="$(git tag --list 'v*' --sort=-v:refname | head -n1)"
          if [ -z "$LATEST_TAG" ]; then NEXT_TAG="v0.1.0"; else
            V="${LATEST_TAG#v}"; IFS='.' read -r MA MI PA <<< "$V"
            : "${MA:=0}"; : "${MI:=1}"; : "${PA:=0}"; PA=$((PA+1))
            NEXT_TAG="v${MA}.${MI}.${PA}"
          fi
          echo "tag=${NEXT_TAG}"       >> "$GITHUB_OUTPUT"
          echo "version=${NEXT_TAG#v}" >> "$GITHUB_OUTPUT"
      - name: Create and push git tag
        shell: bash
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG_NAME}$"; then
            echo "Tag ${TAG_NAME} já existe; seguindo."
          else
            git config user.name  "github-actions"
            git config user.email "github-actions@github.com"
            git tag -a "${TAG_NAME}" -m "Release ${TAG_NAME}"
            git push origin "${TAG_NAME}"
          fi

  release-macos:
    name: macOS • DMG drag-to-Applications (Universal, ad-hoc signed, /usr/local/bin)
    runs-on: macos-latest
    needs: tag
    env:
      VERSION: ${{ needs.tag.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Ensure pricing.yaml exists
        run: |
          test -f pricing.yaml || { echo "pricing.yaml não encontrado na raiz do repo"; exit 1; }
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: '1.22', cache: true }

      # Build universal (arm64 + amd64)
      - name: Build darwin/amd64
        env: { GOOS: darwin, GOARCH: amd64, CGO_ENABLED: 0 }
        run: |
          mkdir -p dist
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_amd64 ${MAIN_PKG}
      - name: Build darwin/arm64
        env: { GOOS: darwin, GOARCH: arm64, CGO_ENABLED: 0 }
        run: |
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_arm64 ${MAIN_PKG}
      - name: Create universal binary (lipo)
        run: |
          lipo -create -output dist/${APP_NAME} dist/${APP_NAME}_amd64 dist/${APP_NAME}_arm64
          chmod +x dist/${APP_NAME}
          file dist/${APP_NAME}

      # Build proper .app bundle (launcher + Info.plist + icon + pricing.yaml + wrapper)
      - name: Create .app bundle (installs libexec + share + wrapper)
        shell: bash
        run: |
          APP="${APP_DISPLAY}.app"
          mkdir -p "$APP/Contents/MacOS" "$APP/Contents/Resources"

          # Info.plist
          cat > "$APP/Contents/Info.plist" <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDevelopmentRegion</key><string>en</string>
            <key>CFBundleDisplayName</key><string>${APP_DISPLAY}</string>
            <key>CFBundleExecutable</key><string>launcher</string>
            <key>CFBundleIdentifier</key><string>${BUNDLE_ID}.${APP_NAME}</string>
            <key>CFBundleInfoDictionaryVersion</key><string>6.0</string>
            <key>CFBundleName</key><string>${APP_DISPLAY}</string>
            <key>CFBundlePackageType</key><string>APPL</string>
            <key>CFBundleShortVersionString</key><string>${VERSION}</string>
            <key>CFBundleVersion</key><string>${VERSION}</string>
            <key>LSMinimumSystemVersion</key><string>11.0</string>
            <key>LSApplicationCategoryType</key><string>public.app-category.developer-tools</string>
            <key>CFBundleIconFile</key><string>AppIcon.icns</string>
          </dict>
          </plist>
          PLIST

          # Launcher template (no expand) + replace placeholders safely
          cat > "$APP/Contents/MacOS/launcher" <<'SH'
          #!/bin/bash
          set -euo pipefail
          BIN_SRC="$(dirname "$0")/../Resources/__APP_BIN__"
          PRICING_SRC="$(dirname "$0")/../Resources/pricing.yaml"
          WRAP_SRC="$(dirname "$0")/../Resources/wrapper.sh"

          TARGET_BIN_DIR="/usr/local/libexec/__APP_NAME__"
          TARGET_SHARE_DIR="/usr/local/share/__APP_NAME__"
          TARGET_LINK="/usr/local/bin/__APP_NAME__"

          /usr/bin/osascript <<OSA
          do shell script "mkdir -p '${TARGET_BIN_DIR}' '${TARGET_SHARE_DIR}' && \
          install -m 0755 '${BIN_SRC}' '${TARGET_BIN_DIR}/__APP_NAME__' && \
          install -m 0644 '${PRICING_SRC}' '${TARGET_SHARE_DIR}/pricing.yaml' && \
          install -m 0755 '${WRAP_SRC}' '${TARGET_LINK}' && \
          xattr -d com.apple.quarantine '${TARGET_BIN_DIR}/__APP_NAME__' || true && \
          xattr -d com.apple.quarantine '${TARGET_LINK}' || true" with administrator privileges
          OSA

          /usr/bin/osascript -e 'display dialog "__APP_DISPLAY__ instalado. Binário em /usr/local/libexec/__APP_NAME__, wrapper em /usr/local/bin/__APP_NAME__ e pricing.yaml em /usr/local/share/__APP_NAME__." buttons {"OK"} default button 1 with icon note'
          SH
          sed -i '' -e "s/__APP_NAME__/${APP_NAME}/g" -e "s/__APP_BIN__/${APP_NAME}/g" -e "s/__APP_DISPLAY__/${APP_DISPLAY}/g" "$APP/Contents/MacOS/launcher"
          chmod +x "$APP/Contents/MacOS/launcher"

          # Binário universal embutido
          cp dist/${APP_NAME} "$APP/Contents/Resources/${APP_NAME}"

          # pricing.yaml embutido
          cp pricing.yaml "$APP/Contents/Resources/pricing.yaml"

          # Wrapper embutido (executa o binário real com variável EC2_PRICING_YAML)
          cat > "$APP/Contents/Resources/wrapper.sh" <<'WRAP'
          #!/bin/bash
          set -euo pipefail
          export EC2_PRICING_YAML="/usr/local/share/__APP_NAME__/pricing.yaml"
          exec /usr/local/libexec/__APP_NAME__/__APP_NAME__ "$@"
          WRAP
          sed -i '' -e "s/__APP_NAME__/${APP_NAME}/g" "$APP/Contents/Resources/wrapper.sh"
          chmod +x "$APP/Contents/Resources/wrapper.sh"

          # Ícone (a partir de assets/icon.png)
          if [ -f assets/icon.png ]; then
            mkdir -p icon.iconset
            for s in 16 32 64 128 256 512 1024; do /usr/bin/sips -z $s $s assets/icon.png --out icon.iconset/icon_${s}x${s}.png >/dev/null; done
            /usr/bin/iconutil -c icns icon.iconset -o "$APP/Contents/Resources/AppIcon.icns"
          fi

      - name: Ad-hoc codesign .app
        run: |
          APP="${APP_DISPLAY}.app"
          codesign --force --deep -s - --timestamp=none "$APP" || true
          codesign -dv "$APP" || true

      - name: Create DMG (drag-to-Applications)
        run: |
          APP="${APP_DISPLAY}.app"
          mkdir -p dmgroot
          cp -R "$APP" dmgroot/
          ln -s /Applications dmgroot/Applications
          DMG="dist/${APP_NAME}_${VERSION}_macOS.dmg"
          hdiutil create -volname "${VOL_NAME}" -srcfolder dmgroot -ov -format UDZO "$DMG"
          echo "DMG_PATH=$DMG" >> $GITHUB_ENV

      - name: Checksums + Upload
        run: |
          shasum -a 256 "$DMG_PATH" > "${DMG_PATH}.sha256"
          cat "${DMG_PATH}.sha256"
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.TAG_NAME }}
          name: ${{ needs.tag.outputs.TAG_NAME }}
          generate_release_notes: true
          files: |
            ${{ env.DMG_PATH }}
            ${{ env.DMG_PATH }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-linux-rpm:
    name: Linux • RPM (x86_64 & aarch64)
    runs-on: ubuntu-latest
    needs: tag
    env:
      VERSION: ${{ needs.tag.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Ensure pricing.yaml exists
        run: |
          test -f pricing.yaml || { echo "pricing.yaml não encontrado na raiz do repo"; exit 1; }
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: '1.22', cache: true }

      - name: Build linux/amd64
        env: { GOOS: linux, GOARCH: amd64, CGO_ENABLED: 0 }
        run: |
          mkdir -p dist
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_linux_amd64 ${MAIN_PKG}

          # Estrutura do pacote (amd64)
          mkdir -p pkg/linux/amd64/usr/local/libexec/${APP_NAME}
          mkdir -p pkg/linux/amd64/usr/local/share/${APP_NAME}
          mkdir -p pkg/linux/amd64/usr/local/bin

          cp dist/${APP_NAME}_linux_amd64 pkg/linux/amd64/usr/local/libexec/${APP_NAME}/${APP_NAME}
          cp pricing.yaml pkg/linux/amd64/usr/local/share/${APP_NAME}/pricing.yaml

          cat > pkg/linux/amd64/usr/local/bin/${APP_NAME} <<'SH'
          #!/bin/bash
          set -euo pipefail
          export EC2_PRICING_YAML="/usr/local/share/__APP_NAME__/pricing.yaml"
          exec /usr/local/libexec/__APP_NAME__/__APP_NAME__ "$@"
          SH
          sed -i -e "s/__APP_NAME__/${APP_NAME}/g" pkg/linux/amd64/usr/local/bin/${APP_NAME}
          chmod 0755 pkg/linux/amd64/usr/local/bin/${APP_NAME}

      - name: Build linux/arm64
        env: { GOOS: linux, GOARCH: arm64, CGO_ENABLED: 0 }
        run: |
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_linux_arm64 ${MAIN_PKG}

          # Estrutura do pacote (arm64)
          mkdir -p pkg/linux/arm64/usr/local/libexec/${APP_NAME}
          mkdir -p pkg/linux/arm64/usr/local/share/${APP_NAME}
          mkdir -p pkg/linux/arm64/usr/local/bin

          cp dist/${APP_NAME}_linux_arm64 pkg/linux/arm64/usr/local/libexec/${APP_NAME}/${APP_NAME}
          cp pricing.yaml pkg/linux/arm64/usr/local/share/${APP_NAME}/pricing.yaml

          cat > pkg/linux/arm64/usr/local/bin/${APP_NAME} <<'SH'
          #!/bin/bash
          set -euo pipefail
          export EC2_PRICING_YAML="/usr/local/share/__APP_NAME__/pricing.yaml"
          exec /usr/local/libexec/__APP_NAME__/__APP_NAME__ "$@"
          SH
          sed -i -e "s/__APP_NAME__/${APP_NAME}/g" pkg/linux/arm64/usr/local/bin/${APP_NAME}
          chmod 0755 pkg/linux/arm64/usr/local/bin/${APP_NAME}

      - name: Install fpm
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems rpm
          sudo gem install --no-document fpm

      - name: Package RPMs & Upload
        run: |
          # amd64
          fpm -s dir -t rpm -n ${APP_NAME} -v ${VERSION} -a x86_64 --license MIT \
            --description "${APP_DISPLAY}" --vendor "${{ github.repository_owner }}" \
            --url "https://github.com/${{ github.repository }}" \
            -C pkg/linux/amd64 usr/local/bin usr/local/libexec usr/local/share

          # arm64
          fpm -s dir -t rpm -n ${APP_NAME} -v ${VERSION} -a aarch64 --license MIT \
            --description "${APP_DISPLAY}" --vendor "${{ github.repository_owner }}" \
            --url "https://github.com/${{ github.repository }}" \
            -C pkg/linux/arm64 usr/local/bin usr/local/libexec usr/local/share

          mv ${APP_NAME}-${VERSION}-1.x86_64.rpm dist/${APP_NAME}_${VERSION}_linux_x86_64.rpm
          mv ${APP_NAME}-${VERSION}-1.aarch64.rpm dist/${APP_NAME}_${VERSION}_linux_aarch64.rpm
          (cd dist && shasum -a 256 *.rpm > SHA256SUMS.rpm.txt)
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.TAG_NAME }}
          name: ${{ needs.tag.outputs.TAG_NAME }}
          files: |
            dist/${{ env.APP_NAME }}_${{ env.VERSION }}_linux_x86_64.rpm
            dist/${{ env.APP_NAME }}_${{ env.VERSION }}_linux_aarch64.rpm
            dist/SHA256SUMS.rpm.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-linux-deb:
    name: Linux • DEB (amd64, arm64 & armhf / Raspberry Pi)
    runs-on: ubuntu-latest
    needs: tag
    env:
      VERSION: ${{ needs.tag.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Ensure pricing.yaml exists
        run: |
          test -f pricing.yaml || { echo "pricing.yaml não encontrado na raiz do repo"; exit 1; }
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: '1.22', cache: true }

      # amd64
      - name: Build linux/amd64
        env: { GOOS: linux, GOARCH: amd64, CGO_ENABLED: 0 }
        run: |
          mkdir -p dist
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_linux_amd64 ${MAIN_PKG}
          mkdir -p pkg/deb/amd64/usr/local/libexec/${APP_NAME} pkg/deb/amd64/usr/local/share/${APP_NAME} pkg/deb/amd64/usr/local/bin
          cp dist/${APP_NAME}_linux_amd64 pkg/deb/amd64/usr/local/libexec/${APP_NAME}/${APP_NAME}
          cp pricing.yaml pkg/deb/amd64/usr/local/share/${APP_NAME}/pricing.yaml
          cat > pkg/deb/amd64/usr/local/bin/${APP_NAME} <<'SH'
          #!/bin/bash
          set -euo pipefail
          export EC2_PRICING_YAML="/usr/local/share/__APP_NAME__/pricing.yaml"
          exec /usr/local/libexec/__APP_NAME__/__APP_NAME__ "$@"
          SH
          sed -i -e "s/__APP_NAME__/${APP_NAME}/g" pkg/deb/amd64/usr/local/bin/${APP_NAME}
          chmod 0755 pkg/deb/amd64/usr/local/bin/${APP_NAME}

      # arm64
      - name: Build linux/arm64
        env: { GOOS: linux, GOARCH: arm64, CGO_ENABLED: 0 }
        run: |
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_linux_arm64 ${MAIN_PKG}
          mkdir -p pkg/deb/arm64/usr/local/libexec/${APP_NAME} pkg/deb/arm64/usr/local/share/${APP_NAME} pkg/deb/arm64/usr/local/bin
          cp dist/${APP_NAME}_linux_arm64 pkg/deb/arm64/usr/local/libexec/${APP_NAME}/${APP_NAME}
          cp pricing.yaml pkg/deb/arm64/usr/local/share/${APP_NAME}/pricing.yaml
          cat > pkg/deb/arm64/usr/local/bin/${APP_NAME} <<'SH'
          #!/bin/bash
          set -euo pipefail
          export EC2_PRICING_YAML="/usr/local/share/__APP_NAME__/pricing.yaml"
          exec /usr/local/libexec/__APP_NAME__/__APP_NAME__ "$@"
          SH
          sed -i -e "s/__APP_NAME__/${APP_NAME}/g" pkg/deb/arm64/usr/local/bin/${APP_NAME}
          chmod 0755 pkg/deb/arm64/usr/local/bin/${APP_NAME}

      # armhf (Raspberry Pi OS 32-bit)
      - name: Build linux/armv7 (armhf)
        env: { GOOS: linux, GOARCH: arm, GOARM: 7, CGO_ENABLED: 0 }
        run: |
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_linux_armv7 ${MAIN_PKG}
          mkdir -p pkg/deb/armhf/usr/local/libexec/${APP_NAME} pkg/deb/armhf/usr/local/share/${APP_NAME} pkg/deb/armhf/usr/local/bin
          cp dist/${APP_NAME}_linux_armv7 pkg/deb/armhf/usr/local/libexec/${APP_NAME}/${APP_NAME}
          cp pricing.yaml pkg/deb/armhf/usr/local/share/${APP_NAME}/pricing.yaml
          cat > pkg/deb/armhf/usr/local/bin/${APP_NAME} <<'SH'
          #!/bin/bash
          set -euo pipefail
          export EC2_PRICING_YAML="/usr/local/share/__APP_NAME__/pricing.yaml"
          exec /usr/local/libexec/__APP_NAME__/__APP_NAME__ "$@"
          SH
          sed -i -e "s/__APP_NAME__/${APP_NAME}/g" pkg/deb/armhf/usr/local/bin/${APP_NAME}
          chmod 0755 pkg/deb/armhf/usr/local/bin/${APP_NAME}

      - name: Install fpm
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential
          sudo gem install --no-document fpm

      - name: Package DEBs & Upload
        run: |
          # amd64
          fpm -s dir -t deb -n ${APP_NAME} -v ${VERSION} -a amd64 --license MIT \
            --description "${APP_DISPLAY}" --vendor "${{ github.repository_owner }}" \
            --url "https://github.com/${{ github.repository }}" \
            -C pkg/deb/amd64 usr/local/bin usr/local/libexec usr/local/share

          # arm64
          fpm -s dir -t deb -n ${APP_NAME} -v ${VERSION} -a arm64 --license MIT \
            --description "${APP_DISPLAY}" --vendor "${{ github.repository_owner }}" \
            --url "https://github.com/${{ github.repository }}" \
            -C pkg/deb/arm64 usr/local/bin usr/local/libexec usr/local/share

          # armhf (Raspberry Pi 32-bit)
          fpm -s dir -t deb -n ${APP_NAME} -v ${VERSION} -a armhf --license MIT \
            --description "${APP_DISPLAY}" --vendor "${{ github.repository_owner }}" \
            --url "https://github.com/${{ github.repository }}" \
            -C pkg/deb/armhf usr/local/bin usr/local/libexec usr/local/share

          mv ${APP_NAME}_${VERSION}_amd64.deb      dist/${APP_NAME}_${VERSION}_linux_amd64.deb
          mv ${APP_NAME}_${VERSION}_arm64.deb      dist/${APP_NAME}_${VERSION}_linux_arm64.deb
          mv ${APP_NAME}_${VERSION}_armhf.deb      dist/${APP_NAME}_${VERSION}_linux_armhf.deb
          (cd dist && shasum -a 256 *.deb > SHA256SUMS.deb.txt)
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.TAG_NAME }}
          name: ${{ needs.tag.outputs.TAG_NAME }}
          files: |
            dist/${{ env.APP_NAME }}_${{ env.VERSION }}_linux_amd64.deb
            dist/${{ env.APP_NAME }}_${{ env.VERSION }}_linux_arm64.deb
            dist/${{ env.APP_NAME }}_${{ env.VERSION }}_linux_armhf.deb
            dist/SHA256SUMS.deb.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
