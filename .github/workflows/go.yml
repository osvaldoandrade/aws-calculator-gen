name: CI, Tag & Multi-Platform Release (macOS DMG drag, NSIS EXE, RPM)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: seidor-aws-cli
  APP_DISPLAY: "Seidor AWS CLI"
  BUNDLE_ID: com.seidor.awscli
  VOL_NAME: "Seidor AWS CLI"
  MAIN_PKG: ./cmd/seidor-aws-cli

jobs:
  build-test:
    name: Build & Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: '1.22', cache: true }
      - name: Build
        run: go build -v ./...
      - name: Test
        run: go test -v ./...

  tag:
    name: Compute & Push Tag
    runs-on: ubuntu-latest
    needs: build-test
    outputs:
      TAG_NAME: ${{ steps.version.outputs.tag }}
      VERSION: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - id: version
        name: Compute next tag (patch bump)
        shell: bash
        run: |
          git fetch --tags
          LATEST_TAG="$(git tag --list 'v*' --sort=-v:refname | head -n1)"
          if [ -z "$LATEST_TAG" ]; then NEXT_TAG="v0.1.0"; else
            V="${LATEST_TAG#v}"; IFS='.' read -r MA MI PA <<< "$V"
            : "${MA:=0}"; : "${MI:=1}"; : "${PA:=0}"; PA=$((PA+1))
            NEXT_TAG="v${MA}.${MI}.${PA}"
          fi
          echo "tag=${NEXT_TAG}"       >> "$GITHUB_OUTPUT"
          echo "version=${NEXT_TAG#v}" >> "$GITHUB_OUTPUT"
      - name: Create and push git tag
        shell: bash
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG_NAME}$"; then
            echo "Tag ${TAG_NAME} já existe; seguindo."
          else
            git config user.name  "github-actions"
            git config user.email "github-actions@github.com"
            git tag -a "${TAG_NAME}" -m "Release ${TAG_NAME}"
            git push origin "${TAG_NAME}"
          fi

  release-macos:
    name: macOS • DMG drag-to-Applications (Universal, ad-hoc signed)
    runs-on: macos-latest
    needs: tag
    env:
      VERSION: ${{ needs.tag.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: '1.22', cache: true }

      # Build universal (arm64 + amd64)
      - name: Build darwin/amd64
        env: { GOOS: darwin, GOARCH: amd64, CGO_ENABLED: 0 }
        run: |
          mkdir -p dist
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_amd64 ${MAIN_PKG}
      - name: Build darwin/arm64
        env: { GOOS: darwin, GOARCH: arm64, CGO_ENABLED: 0 }
        run: |
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_arm64 ${MAIN_PKG}
      - name: Create universal binary (lipo)
        run: |
          lipo -create -output dist/${APP_NAME} dist/${APP_NAME}_amd64 dist/${APP_NAME}_arm64
          chmod +x dist/${APP_NAME}
          file dist/${APP_NAME}

      # Build proper .app bundle (script launcher + Info.plist + icon)
      - name: Create .app bundle
        run: |
          APP="${APP_DISPLAY}.app"
          mkdir -p "$APP/Contents/MacOS" "$APP/Contents/Resources"

          # Info.plist
          cat > "$APP/Contents/Info.plist" <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDevelopmentRegion</key><string>en</string>
            <key>CFBundleDisplayName</key><string>${APP_DISPLAY}</string>
            <key>CFBundleExecutable</key><string>${APP_NAME}-installer</string>
            <key>CFBundleIdentifier</key><string>${BUNDLE_ID}</string>
            <key>CFBundleInfoDictionaryVersion</key><string>6.0</string>
            <key>CFBundleName</key><string>${APP_DISPLAY}</string>
            <key>CFBundlePackageType</key><string>APPL</string>
            <key>CFBundleShortVersionString</key><string>${VERSION}</string>
            <key>CFBundleVersion</key><string>${VERSION}</string>
            <key>LSMinimumSystemVersion</key><string>11.0</string>
            <key>NSHumanReadableCopyright</key><string>© ${GITHUB_REPOSITORY_OWNER}</string>
            <key>LSApplicationCategoryType</key><string>public.app-category.developer-tools</string>
            <key>CFBundleIconFile</key><string>SeidorAWSCLI.icns</string>
          </dict>
          </plist>
          PLIST

          # Installer launcher (bash) - eleva privilégio via AppleScript e copia o binário
          cat > "$APP/Contents/MacOS/${APP_NAME}-installer" <<'SH'
          #!/bin/bash
          set -euo pipefail
          BIN_SRC="$(dirname "$0")/../Resources/seidor-aws-cli"

          # destino: preferir /opt/homebrew/bin (Apple Silicon) se existir; caso contrário /usr/local/bin
          TARGET="/usr/local/bin"
          if [ -d "/opt/homebrew/bin" ]; then TARGET="/opt/homebrew/bin"; fi

          /usr/bin/osascript <<OSA
          do shell script "mkdir -p '${TARGET}' && install -m 0755 '${BIN_SRC}' '${TARGET}/seidor-aws-cli' && xattr -d com.apple.quarantine '${TARGET}/seidor-aws-cli' || true" with administrator privileges
          OSA

          /usr/bin/osascript -e 'display dialog "Seidor AWS CLI instalado em '"${TARGET}"'." buttons {"OK"} default button 1 with icon note'
          SH
          chmod +x "$APP/Contents/MacOS/${APP_NAME}-installer"

          # Copia binário universal para Resources
          cp dist/${APP_NAME} "$APP/Contents/Resources/seidor-aws-cli"

          # Ícone (se houver)
          if [ -f assets/icon.png ]; then
            mkdir -p icon.iconset
            for s in 16 32 64 128 256 512 1024; do /usr/bin/sips -z $s $s assets/icon.png --out icon.iconset/icon_${s}x${s}.png >/dev/null; done
            /usr/bin/iconutil -c icns icon.iconset -o "$APP/Contents/Resources/SeidorAWSCLI.icns"
          else
            # sem ícone custom, usa genérico (só para não quebrar)
            : # nada
          fi

      # Ad-hoc codesign do .app (evita "app danificado"; ainda não é notarizado)
      - name: Ad-hoc sign .app
        run: |
          APP="${APP_DISPLAY}.app"
          codesign --force --deep -s - --timestamp=none "$APP"
          codesign -dv "$APP" || true

      # Monta DMG com link para /Applications
      - name: Create DMG (drag-to-Applications)
        run: |
          APP="${APP_DISPLAY}.app"
          mkdir -p dmgroot
          cp -R "$APP" dmgroot/
          ln -s /Applications dmgroot/Applications
          DMG="dist/${APP_NAME}_${VERSION}_macOS.dmg"
          hdiutil create -volname "${VOL_NAME}" -srcfolder dmgroot -ov -format UDZO "$DMG"
          echo "DMG_PATH=$DMG" >> $GITHUB_ENV

      - name: Checksums
        run: |
          shasum -a 256 "$DMG_PATH" > "${DMG_PATH}.sha256"
          cat "${DMG_PATH}.sha256"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.TAG_NAME }}
          name: ${{ needs.tag.outputs.TAG_NAME }}
          generate_release_notes: true
          files: |
            ${{ env.DMG_PATH }}
            ${{ env.DMG_PATH }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-linux-rpm:
    name: Linux • RPM (x86_64 & aarch64)
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: '1.22', cache: true }
      - name: Build linux/amd64
        env: { GOOS: linux, GOARCH: amd64, CGO_ENABLED: 0 }
        run: |
          mkdir -p dist pkg/linux/amd64
          go build -trimpath -ldflags="-s -w -X main.version=${{ needs.tag.outputs.VERSION }}" -o dist/${APP_NAME}_linux_amd64 ${MAIN_PKG}
          cp dist/${APP_NAME}_linux_amd64 pkg/linux/amd64/${APP_NAME}
      - name: Build linux/arm64
        env: { GOOS: linux, GOARCH: arm64, CGO_ENABLED: 0 }
        run: |
          mkdir -p pkg/linux/arm64
          go build -trimpath -ldflags="-s -w -X main.version=${{ needs.tag.outputs.VERSION }}" -o dist/${APP_NAME}_linux_arm64 ${MAIN_PKG}
          cp dist/${APP_NAME}_linux_arm64 pkg/linux/arm64/${APP_NAME}
      - name: Install fpm
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems rpm
          sudo gem install --no-document fpm
      - name: Package RPMs & Upload
        run: |
          fpm -s dir -t rpm -n ${APP_NAME} -v ${{ needs.tag.outputs.VERSION }} -a x86_64 --license MIT \
            --description "${APP_DISPLAY}" --vendor "${{ github.repository_owner }}" \
            --url "https://github.com/${{ github.repository }}" \
            pkg/linux/amd64/${APP_NAME}=/usr/local/bin/${APP_NAME}
          fpm -s dir -t rpm -n ${APP_NAME} -v ${{ needs.tag.outputs.VERSION }} -a aarch64 --license MIT \
            --description "${APP_DISPLAY}" --vendor "${{ github.repository_owner }}" \
            --url "https://github.com/${{ github.repository }}" \
            pkg/linux/arm64/${APP_NAME}=/usr/local/bin/${APP_NAME}
          mv ${APP_NAME}-${{ needs.tag.outputs.VERSION }}-1.x86_64.rpm dist/${APP_NAME}_${{ needs.tag.outputs.VERSION }}_linux_x86_64.rpm
          mv ${APP_NAME}-${{ needs.tag.outputs.VERSION }}-1.aarch64.rpm dist/${APP_NAME}_${{ needs.tag.outputs.VERSION }}_linux_aarch64.rpm
          (cd dist && shasum -a 256 *.rpm > SHA256SUMS.rpm.txt)
        shell: bash
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.TAG_NAME }}
          name: ${{ needs.tag.outputs.TAG_NAME }}
          files: |
            dist/${{ env.APP_NAME }}_${{ needs.tag.outputs.VERSION }}_linux_x86_64.rpm
            dist/${{ env.APP_NAME }}_${{ needs.tag.outputs.VERSION }}_linux_aarch64.rpm
            dist/SHA256SUMS.rpm.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-windows:
    name: Windows • NSIS installers (x64 & ARM64) with icon
    runs-on: windows-latest
    needs: tag
    env:
      VERSION: ${{ needs.tag.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: '1.22', cache: true }

      - name: Build windows/amd64
        shell: bash
        env: { GOOS: windows, GOARCH: amd64, CGO_ENABLED: 0 }
        run: |
          mkdir -p dist
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_windows_amd64.exe ${MAIN_PKG}
      - name: Build windows/arm64
        shell: bash
        env: { GOOS: windows, GOARCH: arm64, CGO_ENABLED: 0 }
        run: |
          go build -trimpath -ldflags="-s -w -X main.version=${VERSION}" -o dist/${APP_NAME}_windows_arm64.exe ${MAIN_PKG}

      - name: Install NSIS
        run: choco install nsis -y

      - name: Generate NSIS scripts (icons if available)
        shell: pwsh
        run: |
          $icon = (Test-Path assets/icon.ico) ? 'Icon assets\icon.ico' : ''
          $nsis = @"
          !include "MUI2.nsh"
          !define APP_NAME  "${{ env.APP_DISPLAY }}"
          !define BIN_NAME  "seidor-aws-cli.exe"
          !define VERSION   "${{ env.VERSION }}"
          !define COMPANY   "${{ github.repository_owner }}"
          !define URL       "https://github.com/${{ github.repository }}"
          RequestExecutionLevel admin
          !define MUI_ABORTWARNING
          @ICON@
          Var Arch
          !macro MakeInstaller ARCH BINPATH OUTFILE
            OutFile "${OUTFILE}"
            !ifdef ICON
            !endif
            InstallDir "$PROGRAMFILES64\Seidor AWS CLI"
            Name "${APP_NAME} (${ARCH})"
            BrandingText "Seidor AWS CLI ${VERSION} (${ARCH})"
            !insertmacro MUI_PAGE_WELCOME
            !insertmacro MUI_PAGE_DIRECTORY
            !insertmacro MUI_PAGE_INSTFILES
            !insertmacro MUI_PAGE_FINISH
            !insertmacro MUI_UNPAGE_CONFIRM
            !insertmacro MUI_UNPAGE_INSTFILES
            !insertmacro MUI_LANGUAGE "English"
            Section "Install"
              SetOutPath "$INSTDIR"
              File "${BINPATH}"
              Rename "$INSTDIR\${APP_NAME}_${VERSION}_windows_${ARCH}.exe" "$INSTDIR\${BIN_NAME}"
              ReadRegStr $0 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
              ${If} $0 != ""
                StrCpy $1 "$0;$INSTDIR"
                WriteRegExpandStr HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path" "$1"
                System::Call 'USER32::SendMessageTimeout(p 0xffff, i ${WM_SETTINGCHANGE}, p 0, t "Environment", i 0x0000, i 5000, *i .r0)'
              ${EndIf}
              CreateShortCut "$SMPROGRAMS\Seidor AWS CLI\Seidor AWS CLI.lnk" "$INSTDIR\${BIN_NAME}"
            SectionEnd
            Section "Uninstall"
              Delete "$INSTDIR\${BIN_NAME}"
              RMDir /r "$SMPROGRAMS\Seidor AWS CLI"
              RMDir "$INSTDIR"
            SectionEnd
          !macroend
          "@
          if ($icon -ne '') { $nsis = $nsis -replace '@ICON@', '!define MUI_ICON "assets\\icon.ico"' } else { $nsis = $nsis -replace '@ICON@', '' }
          Set-Content -Path installer_x64.nsi  -Value ($nsis + @"
          !define OUTFILE "dist\seidor-aws-cli_${{ env.VERSION }}_windows_x64_setup.exe"
          !insertmacro MakeInstaller "x64" "dist\seidor-aws-cli_windows_amd64.exe" "${OUTFILE}"
          "@) -Encoding ASCII
          Set-Content -Path installer_arm64.nsi -Value ($nsis + @"
          !define OUTFILE "dist\seidor-aws-cli_${{ env.VERSION }}_windows_arm64_setup.exe"
          !insertmacro MakeInstaller "arm64" "dist\seidor-aws-cli_windows_arm64.exe" "${OUTFILE}"
          "@) -Encoding ASCII

      - name: Build NSIS installers
        shell: pwsh
        run: |
          & 'C:\Program Files (x86)\NSIS\makensis.exe' /V2 installer_x64.nsi
          & 'C:\Program Files (x86)\NSIS\makensis.exe' /V2 installer_arm64.nsi
          Get-ChildItem dist\*.exe

      - name: Checksums + Upload
        shell: pwsh
        run: |
          Get-FileHash -Algorithm SHA256 "dist\seidor-aws-cli_${env:VERSION}_windows_x64_setup.exe"   | ForEach-Object { "$($_.Hash)  $($_.Path)" } | Out-File -Encoding ASCII "dist\seidor-aws-cli_${env:VERSION}_windows_x64_setup.exe.sha256"
          Get-FileHash -Algorithm SHA256 "dist\seidor-aws-cli_${env:VERSION}_windows_arm64_setup.exe" | ForEach-Object { "$($_.Hash)  $($_.Path)" } | Out-File -Encoding ASCII "dist\seidor-aws-cli_${env:VERSION}_windows_arm64_setup.exe.sha256"
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.TAG_NAME }}
          name: ${{ needs.tag.outputs.TAG_NAME }}
          files: |
            dist/seidor-aws-cli_${{ env.VERSION }}_windows_x64_setup.exe
            dist/seidor-aws-cli_${{ env.VERSION }}_windows_x64_setup.exe.sha256
            dist/seidor-aws-cli_${{ env.VERSION }}_windows_arm64_setup.exe
            dist/seidor-aws-cli_${{ env.VERSION }}_windows_arm64_setup.exe.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
